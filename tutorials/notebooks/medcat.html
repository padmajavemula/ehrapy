<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

<meta property="og:title" content="Extracting from free text with MedCAT" />
  
<meta property="og:type" content="website" />
  
<meta property="og:url" content="https://ehrapy.readthedocs.io/en/latest/tutorials/notebooks/medcat.html" />
  
<meta property="og:description" content="This tutorial serves as an introduction on how to use ehrapy together with MedCAT. MedCat is a tool to extract medical entities from free text and link it to biomedical ontologies. Biomedical entit..." />
  
<meta property="og:image" content="https://ehrapy.readthedocs.io/en/latest//_static/logo.png" />
  
<meta property="og:image:alt" content="Extracting from free text with MedCAT" />
  <link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Contributor Guide" href="../../contributing.html" /><link rel="prev" title="Diabetes 130 Vignette" href="diabetes_130.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>Extracting from free text with MedCAT - ehrapy</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/override.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/sphinx_gallery.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #003262;
  --color-brand-content: #003262;
  --admonition-font-size: var(--font-size-normal);
  --admonition-title-font-size: var(--font-size-normal);
  --code-font-size: var(--font-size--small);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ehrapy</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/ehrapy_pure.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/usage.html">Usage</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ehrapy_introduction.html">ehrapy Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="ehrapy_introduction.html#Fundamental-Principles">Fundamental Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html">MIMIC-II IAC Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Preprocessing">Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#PCA-&amp;-UMAP">PCA &amp; UMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Batch-effect-check">Batch effect check</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Leiden-clustering">Leiden clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Hospital-&amp;-ICU-statistics">Hospital &amp; ICU statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Death">Death</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Demographics">Demographics</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Comorbidities">Comorbidities</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Initial-lab-measurements">Initial lab measurements</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Annotation">Annotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_introduction.html#Paga">Paga</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_fate.html">MIMIC-II Patient Fate</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_fate.html#Determining-patient-fate-using-a-ConnectivityKernel">Determining patient fate using a ConnectivityKernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimic_2_fate.html#Determining-patient-fate-with-a-PseudotimeKernel">Determining patient fate with a PseudotimeKernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="diabetes_130.html">Diabetes 130 Vignette</a></li>
<li class="toctree-l2"><a class="reference internal" href="diabetes_130.html#Visual-Exploration">Visual Exploration</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Extracting from free text with MedCAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Custom-MedCAT-object-of-ehrapy">Custom MedCAT object of ehrapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Extracting-and-visualizing-all-disease-entities">Extracting and visualizing all disease entities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/theislab/ehrapy/discussions">Discussions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<style>
    p {
        margin-bottom: 0.5rem;
    }
    /* Main index page overview cards */
    /* https://github.com/spatialaudio/nbsphinx/pull/635/files */
    .jp-RenderedHTMLCommon table,
    div.rendered_html table {
    border: none;
    border-collapse: collapse;
    border-spacing: 0;
    font-size: 12px;
    table-layout: fixed;
    color: inherit;
    }

    body:not([data-theme=light]) .jp-RenderedHTMLCommon tbody tr:nth-child(odd),
    body:not([data-theme=light]) div.rendered_html tbody tr:nth-child(odd) {
    background: rgba(255, 255, 255, .1);
    }
</style><div class="admonition note">
<p class="admonition-title">Note</p>
<p>
    This page was generated from
    <a class="reference external" href="https://github.com/theislab/ehrapy/tree/0.2.0/">medcat.ipynb</a>.
    Some tutorial content may look better in light mode.
    </p>
</div><section id="Extracting-from-free-text-with-MedCAT">
<h1>Extracting from free text with MedCAT<a class="headerlink" href="#Extracting-from-free-text-with-MedCAT" title="Permalink to this headline">#</a></h1>
<p>This tutorial serves as an introduction on how to use <em>ehrapy</em> together with <a class="reference external" href="https://github.com/CogStack/MedCAT">MedCAT</a>. <em>MedCat</em> is a tool to extract medical entities from free text and link it to biomedical ontologies. Biomedical entities could be anything biomedical; not only diagnoses or diseases but also symptoms, drugs or even peptides. It also tries to keep the context of an extracted entitiy (for example, whether a specific disease has been diagnosed or not). This is especially
important for electronic health records data, as most of the time doctors notes are simply copied and pasted into the data and not preprocessed in any form. Consider the following example:</p>
<ul class="simple">
<li><p>The patient suffers from diabetes.</p></li>
</ul>
<p>vs.</p>
<ul class="simple">
<li><p>The patient does not suffer from diabetes.</p></li>
</ul>
<p>In detail, ehrapy uses a pretrained and packages model from MedCat (<a class="reference external" href="https://medcat.readthedocs.io/en/latest/main.html#models">https://medcat.readthedocs.io/en/latest/main.html#models</a>). This model is limited in performance but good enough for this demonstration. A larger (trained) model is planned to be released somewhen in the (near) future by the MedCAT maintainers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import ehrapy as ep
import spacy
import pandas as pd
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">Installed version </span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">0.2</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">0</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold"> of ehrapy is newer than the latest release </span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">0.1</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">0</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">! You are running a </span>
<span style="color: #808000; text-decoration-color: #808000; font-weight: bold">nightly version and features may break!</span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/zeth/miniconda3/envs/ehrapy/lib/python3.8/site-packages/medcat/cat.py:18: TqdmExperimentalWarning: Using `tqdm.autonotebook.tqdm` in notebook mode. Use `tqdm.tqdm` instead to force console mode (e.g. in jupyter console)
  from tqdm.autonotebook import tqdm, trange
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.settings.n_jobs = 8
</pre></div>
</div>
</div>
<p>Download the example data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!wget -nc https://raw.githubusercontent.com/CogStack/MedCAT/master/tutorial/data/pt_notes.csv -P ./medcat_data/
!wget -nc https://medcat.rosalind.kcl.ac.uk/media/medmen_wstatus_2021_oct.zip -P ./medcat_data/
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
File ‘./medcat_data/pt_notes.csv’ already there; not retrieving.

File ‘./medcat_data/medmen_wstatus_2021_oct.zip’ already there; not retrieving.

</pre></div></div>
</div>
</section>
<section id="Custom-MedCAT-object-of-ehrapy">
<h1>Custom MedCAT object of ehrapy<a class="headerlink" href="#Custom-MedCAT-object-of-ehrapy" title="Permalink to this headline">#</a></h1>
<p>To allow for seemless interoperability of ehrapy and MedCAT, we require a “superobject” that references the AnnData object while providing the MedCAT functionality. This object further stores MedCAT related features such as a <em>vocabulary</em>, a <em>concept database</em> and (later on in this tutorial) also the <em>annotated results</em>.</p>
<p>First, we read the example data into an AnnData object, encode the data and calculate neighbors for subsequent processing. As a next step, we create the MedCAT object with a modelpack and set default TUI filters. A full list of TUI’s can be found at: <a class="reference external" href="https://lhncbc.nlm.nih.gov/ii/tools/MetaMap/Docs/SemanticTypes_2018AB.txt">https://lhncbc.nlm.nih.gov/ii/tools/MetaMap/Docs/SemanticTypes_2018AB.txt</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata = ep.io.read_csv("medcat_data/pt_notes.csv", columns_obs_only=["text"])
adata_encoded = ep.pp.encode(adata, autodetect=True)
ep.pp.neighbors(adata_encoded)

# create the main ehrapy medcat object used for medical entitiy analysis using ehrapy and medcat
ep_medcat = ep.tl.MedCAT(
    adata_encoded, model_pack_path="./medcat_data/medmen_wstatus_2021_oct"
)
# only use diseases and behavioural disorders diagnoses in this example by filtering by TUI
ep_medcat.set_filter_by_tui(tuis=["T047", "T048"])
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "784ebdbe1b224205a0553ade70dff2a9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">/home/zeth/PycharmProjects/ehrapy/ehrapy/preprocessing/encoding/_encode.py:227:
FutureWarning: X.dtype being converted to np.float32 from object. In the next version of
anndata (0.9) conversion will not be automatic. Pass dtype explicitly to avoid this warning.
Pass `AnnData(X, dtype=X.dtype, ...)` to get the future behavour.
  encoded_ann_data = AnnData(
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Found an existing unziped model pack at: ./medcat_data/medmen_wstatus_2021_oct, the provided zip will not be touched.
{
  "Model ID": null,
  "Last Modifed On": null,
  "History (from least to most recent)": [],
  "Description": "No description",
  "Source Ontology": null,
  "Location": null,
  "MetaCAT models": {},
  "Basic CDB Stats": {},
  "Performance": {
    "ner": {},
    "meta": {}
  },
  "Important Parameters (Partial view, all available in cat.config)": {
    "config.ner['min_name_len']": {
      "value": 3,
      "description": "Minimum detection length (found terms/mentions shorter than this will not be detected)."
    },
    "config.ner['upper_case_limit_len']": {
      "value": 3,
      "description": "All detected terms shorter than this value have to be uppercase, otherwise they will be ignored."
    },
    "config.linking['similarity_threshold']": {
      "value": 0.2,
      "description": "If the confidence of the model is lower than this a detection will be ignore."
    },
    "config.general['spell_check']": {
      "value": true,
      "description": "Is spell checking enabled."
    },
    "config.general['spell_check_len_limit']": {
      "value": 7,
      "description": "Words shorter than this will not be spell checked."
    }
  }
}
</pre></div></div>
</div>
<p>Using this model pack we can already extract entities from an example note.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>text = "He was diagnosed with kidney failure"
doc = ep_medcat.cat(text)
doc.ents
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(kidney failure,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Example output of an extracted medcat entity; note that ehrapy will deal with this automatically and the here displayed manual extraction is not required.
# CUI: Concept Unique Identifier, which is just an unique identifier for each concept extracted
ep_medcat.cat.get_entities("He was diagnosed with kidney failure", only_cui=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'entities': {2: {'pretty_name': 'Kidney Failure',
   'cui': 'C0035078',
   'type_ids': ['T047'],
   'types': ['Disease or Syndrome'],
   'source_value': 'kidney failure',
   'detected_name': 'kidney~failure',
   'acc': 1.0,
   'context_similarity': 1.0,
   'start': 22,
   'end': 36,
   'icd10': [],
   'ontologies': [],
   'snomed': [],
   'id': 2,
   'meta_anns': {'Status': {'value': 'Affirmed',
     'confidence': 0.9999961853027344,
     'name': 'Status'}}}},
 'tokens': []}
</pre></div></div>
</div>
</section>
<section id="Extracting-and-visualizing-all-disease-entities">
<h1>Extracting and visualizing all disease entities<a class="headerlink" href="#Extracting-and-visualizing-all-disease-entities" title="Permalink to this headline">#</a></h1>
<p>To extract all disease entities from our example dataset we require a complete annotation of the dataset. This step is computationally expensive and may take some time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.mc.annotate_text(ep_medcat, text_column="text", n_proc=8)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Annotated until now: 0 docs; Current BS: 157 docs; Elapsed time: 0.00 minutes
Annotated until now: 0 docs; Current BS: 165 docs; Elapsed time: 0.08 minutes
Annotated until now: 15 docs; Current BS: 151 docs; Elapsed time: 0.18 minutes
Annotated until now: 36 docs; Current BS: 160 docs; Elapsed time: 0.30 minutes
Annotated until now: 54 docs; Current BS: 152 docs; Elapsed time: 0.41 minutes
Annotated until now: 68 docs; Current BS: 130 docs; Elapsed time: 0.51 minutes
Annotated until now: 89 docs; Current BS: 157 docs; Elapsed time: 0.63 minutes
Annotated until now: 120 docs; Current BS: 16 docs; Elapsed time: 0.76 minutes
</pre></div></div>
</div>
<p>The annotated results as extracted by MedCAT are transformed and stored into a Pandas DataFrame</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep_medcat.annotated_results
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>row_nr</th>
<th>pretty_name</th>
<th>cui</th>
<th>type_ids</th>
<th>types</th>
<th>meta_anns</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1072</td>
<td>Pneumonia</td>
<td>C0032285</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Affirmed</td>
</tr>
<tr>
<th>1</th>
<td>1072</td>
<td>Rheumatism</td>
<td>C0035435</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
<tr>
<th>2</th>
<td>1072</td>
<td>Anxiety state</td>
<td>C0700613</td>
<td>[T048]</td>
<td>[Mental or Behavioral Dysfunction]</td>
<td>Affirmed</td>
</tr>
<tr>
<th>3</th>
<td>1072</td>
<td>Cerebrovascular accident</td>
<td>C0038454</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
<tr>
<th>4</th>
<td>1072</td>
<td>Memory impairment</td>
<td>C0233794</td>
<td>[T048]</td>
<td>[Mental or Behavioral Dysfunction]</td>
<td>Affirmed</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>1287</th>
<td>945</td>
<td>Hematological Disease</td>
<td>C0018939</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
<tr>
<th>1288</th>
<td>945</td>
<td>Erythema</td>
<td>C0041834</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
<tr>
<th>1289</th>
<td>945</td>
<td>Disease</td>
<td>C0012634</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Affirmed</td>
</tr>
<tr>
<th>1290</th>
<td>945</td>
<td>Abscess</td>
<td>C0000833</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
<tr>
<th>1291</th>
<td>945</td>
<td>Erythema</td>
<td>C0041834</td>
<td>[T047]</td>
<td>[Disease or Syndrome]</td>
<td>Other</td>
</tr>
</tbody>
</table></div>
<p>1292 rows × 6 columns</p>
</div></div>
</div>
<p>We can also get a proper overview for the top 10 most entities found in the data (affirmed diagnoses only).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.mc.get_annotation_overview(ep_medcat)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
 <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> pretty_name        </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> type_ids </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> types              </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> n_patient_visit </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> n_patient_visit_p… </span>
 ───────────────────────────────────────────────────────────────────────────────────────────
  Hypertensive         T047       Disease or           63                50.4
  disease                         Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Obesity            </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 47              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 37.6               </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Coronary             T047       Disease or           23                18.4
  Arteriosclerosis                Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Diabetes Mellitus  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 21              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 16.8               </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Cerebrovascular      T047       Disease or           20                16.0
  accident                        Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Hypercholesterole… </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 19              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 15.2               </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Diabetes             T047       Disease or           16                12.8
                                  Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Anxiety state      </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T048     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Mental or          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 16              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 12.8               </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Behavioral         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Dysfunction        </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Asthma               T047       Disease or           15                12.0
                                  Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Mental Depression  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T048     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Mental or          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 15              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 12.0               </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Behavioral         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Dysfunction        </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>

</pre></div>
</div>
<p>Alternatively, we can also get an overview of the top 10 negated diagnoses only.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.mc.get_annotation_overview(ep_medcat, status="Other")
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
 <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> pretty_name        </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> type_ids </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> types              </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> n_patient_visit </span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> n_patient_visit_p… </span>
 ───────────────────────────────────────────────────────────────────────────────────────────
  Cerebrovascular      T047       Disease or           17                17.17171717171717
  accident                        Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Diabetes           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 9               </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 9.090909090909092  </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Disease              T047       Disease or           9                 9.090909090909092
                                  Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Incontinence       </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8               </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8.080808080808081  </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Rheumatism           T047       Disease or           8                 8.080808080808081
                                  Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Dementia           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T048     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Mental or          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8               </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8.080808080808081  </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Behavioral         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Dysfunction        </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Coronary             T047       Disease or           7                 7.07070707070707
  Arteriosclerosis                Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Erythema           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7               </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7.07070707070707   </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
  Dehydration          T047       Disease or           6                 6.0606060606060606
                                  Syndrome
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Pulmonary Embolism </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> T047     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Disease or         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6               </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6.0606060606060606 </span>
 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">          </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> Syndrome           </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>

</pre></div>
</div>
<p>Since our MedCAT is aware of both, the annotation results and the AnnData object, we can just pass it to any plotting functions of ehrapy, just we like we are used to with AnnData objects. First, we calculate a UMAP embedding using the AnnData object and then we color by all patients that had some form of Pneumonia.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.umap(ep_medcat.anndata)
ep.pl.umap(ep_medcat, color=["Diabetes", "Congestive heart failure"])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_20_0.png" src="../../_images/tutorials_notebooks_medcat_20_0.png"/>
</div>
</div>
<p>It is still possible to color by the original columns in the AnnData object with the MedCAT object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.pl.umap(ep_medcat, color=["gender", "age_year", "Diabetes"])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_22_0.png" src="../../_images/tutorials_notebooks_medcat_22_0.png"/>
</div>
</div>
<p>Passing an AnnData object instead of an ehrapy MedCAT object will also work, but not with extracted entities.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.pl.umap(ep_medcat.anndata, color=["gender", "age_year"])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_24_0.png" src="../../_images/tutorials_notebooks_medcat_24_0.png"/>
</div>
</div>
<p>Typos are automatically fixed by ehrapy whenever possible.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.pl.umap(ep_medcat, color=["Diubetes", "Heart Failure"])
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">Did not find </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">Diubetes </span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">in medcat's extracted entities. Will use best match Diabetes!</span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">Did not find </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">Heart Failure </span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">in medcat's extracted entities. Will use best match Congestive </span>
<span style="color: #808000; text-decoration-color: #808000; font-weight: bold">heart failure!</span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_26_2.png" src="../../_images/tutorials_notebooks_medcat_26_2.png"/>
</div>
</div>
<p>All other features of ehrapy are of course also available.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.leiden(ep_medcat.anndata, resolution=0.5, key_added="leiden_0_5")
ep.tl.paga(ep_medcat.anndata, groups="leiden_0_5")

# paga currently does not support medcat extracted entities directly (as of ehrapy 0.2.0)
ep.pl.paga(
    ep_medcat.anndata,
    color=["leiden_0_5", "gender"],
    cmap=ep.pl.Colormaps.grey_red.value,
    title=["Leiden 0.5", "Gender"],
)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_28_0.png" src="../../_images/tutorials_notebooks_medcat_28_0.png"/>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.tl.draw_graph(ep_medcat.anndata, init_pos="paga")
ep.pl.draw_graph(ep_medcat, color=["gender", "Diabetes"], legend_loc="on data")
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_29_0.png" src="../../_images/tutorials_notebooks_medcat_29_0.png"/>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ep.pl.tracksplot(ep_medcat, list(ep_medcat.anndata.var_names), groupby="Diabetes")
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_notebooks_medcat_30_0.png" src="../../_images/tutorials_notebooks_medcat_30_0.png"/>
</div>
</div>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../contributing.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Contributor Guide</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="diabetes_130.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Diabetes 130 Vignette</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, Lukas Heumos, Theislab
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Extracting from free text with MedCAT</a></li>
<li><a class="reference internal" href="#Custom-MedCAT-object-of-ehrapy">Custom MedCAT object of ehrapy</a></li>
<li><a class="reference internal" href="#Extracting-and-visualizing-all-disease-entities">Extracting and visualizing all disease entities</a></li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>